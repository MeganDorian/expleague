<div ng-controller="ResultController">
  <super-navbar>
    <super-navbar-title>Результаты поиска</super-navbar-title>
    <super-navbar-button side="left" ng-click="backToHistory()">‹ История</super-navbar-button>
  </super-navbar>

  <div class="log"></div>
</div>

<script>
$(document).ready(function() {
  // XMPP
  function log(txt) {
    $('.log').append('<div>' + txt + '</div>');
  }
  // var bosh = 'http://77.88.2.245:5280/';
  // var jid = 'solar@localhost/client';
  // var password = 'ik30239';
  // var timestamp = new Date().getTime();
  // var room = 'room-' + timestamp + '@muc.localhost';
  var bosh = 'http://toobusytosearch.net:5280/';
  var jid = 'testclient@toobusytosearch.net';
  var password = 'qwerty';
  var timestamp = new Date().getTime();
  var room = 'room' + timestamp + '@muc.toobusytosearch.net';
  var nick = 'client1';

  log('jid: ' + jid);
  log('room: ' + room);
  log('nick: ' + nick);

  var conn = new Strophe.Connection(bosh);
  conn.connect(jid, password, function (status) {
    if (status === Strophe.Status.CONNECTED) {
      log('connected');

      function room_message(message) {
        var body = $(message).children('body').text();
        if (body == 'Room is locked. Please configure.') {
          conn.muc.saveConfiguration(room, [],
            function () {
              console.log('saveConfiguration success');
              conn.muc.setTopic(room, searchText);
              log('topic: ' + searchText);
              conn.addHandler(on_public_message, null, "message", "groupchat");
            },
            function (err) {
              console.log('saveConfiguration error: ', err);
            }
          );
        }
        else {
          log('message', message);
        }
      }

      function on_presence(data) {
        console.log('presence', data)
      }

      function on_roster(data) {
        console.log('roster', data)
      }

      conn.muc.join(room, nick, room_message, on_presence, on_roster);

      function on_public_message(message) {
        var body = $(message).children('body').text();
        log('message: ' + body);
          return true;
      }

    } else if (status === Strophe.Status.DISCONNECTED) {
      log('disconnected');
    }
    if (status == Strophe.Status.CONNECTING) {
      log('Connecting');
    }
    else if (status == Strophe.Status.AUTHFAIL) {
      log('Strophe failed to auth');
    }
    else if (
            status == Strophe.Status.ERROR ||
            status == Strophe.Status.CONNFAIL ||
            status == Strophe.Status.DISCONNECTED ||
            status == Strophe.Status.DISCONNECTING
    ){
      log('Strophe failed to connect with status ' + status);
    }
    else {
      log("Unknown status" + status);
    }
  });
});
</script>