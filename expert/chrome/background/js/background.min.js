"use strict";chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(function(b){DRAGDIS.executeApiCall=function(b,c){var d=b.method;"retryItemUpload"==b.method&&DRAGDIS.failedItemUpload&&(b=DRAGDIS.failedItemUpload.request,c=DRAGDIS.failedItemUpload.sender),DRAGDIS.api[b.method](b,c).then(function(b){a.postMessage(b)},function(e){403===e.status&&e.data.ShareResult||"Upload"==b.method&&"retryItemUpload"!=d&&(DRAGDIS.failedItemUpload={request:b,sender:c},DRAGDIS.sendMessage({Type:"DISPLAY_UPLOAD_ERROR"})),a.postMessage(e)})},DRAGDIS.executeApiCall(b,b.sender)})}),DRAGDIS.storage.set("Domain",DRAGDIS.config.domain),DRAGDIS.storage.set("ConnectionFail",!1),DRAGDIS.storage.set("IsConnected",!1),DRAGDIS.storage.set("FoldersList",{}),DRAGDIS.storage.set("UserActive",{Active:!1}),DRAGDIS.storage.set("CurrentSender","empty"),DRAGDIS.storage.set("AppConfig","empty"),DRAGDIS.storage.set("ScrollPosition",null),DRAGDIS.screenSnapshotValue="",DRAGDIS.imageProcessor={makeSnapshot:function(a){var b=this,c=(new Date).getTime(),d=DRAGDIS.config.browser.version<34?{format:"png"}:{format:"jpeg",quality:90};window.chrome.tabs.captureVisibleTab(null,d,function(d){c+DRAGDIS.config.timing.snapshotTimeout>(new Date).getTime()?("Windows"===DRAGDIS.config.browser.OS?b.crop(d,function(b){a(b)}):a(d),a(d)):a(0)})},crop:function(a,b){DRAGDIS.config.canvasEnabled?this.getBase64String(a,function(a){b(a)},20):b(a)},getBase64String:function(a,b,c){$("<img />",{src:a}).load(function(){var d=document.createElement("canvas");d.width=this.width-c,d.height=this.height;var e=d.getContext("2d"),f=0,g=0,h=this.width,i=this.height;e.drawImage(this,f,g,h,i);var j=d.toDataURL();b(j)})},convertBase64toAb:function(a){if(a){for(var b=window.atob(a),c=b.length,d=new Uint8Array(c),e=0;c>e;e++){var f=b.charCodeAt(e);d[e]=f}return{size:c,binary:d.buffer}}return{size:0,binary:null}},getRemoteImageStream:function(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="blob",c.onload=function(a){b(a.target.response)},c.send()},getBiggerImage:function(a,b,c){switch(b){case"fb":var d=[a.replace("_q.jpg","_n.jpg"),a.replace("s480x480/","").replace("_s.jpg","_n.jpg")];if(a.indexOf("safe_image.php")>=0){var e=DRAGDIS.urlParam("url",a);e||a.push(e)}c(this.checkRemoteFiles(d,a));break;case"ffffound":c(this.checkRemoteFiles([a.replace("_xs.jpg","_m.jpg").replace("_s.jpg","_m.jpg").replace("_xs.png","_m.png").replace("_s.png","_m.png").replace("_xs.gif","_m.gif").replace("_s.gif","_m.gif")],a));break;case"pinterest":c(this.checkRemoteFiles([a.replace("_b.jpg","_c.jpg").replace("_t.jpg","_c.jpg")],a));break;case"twitter":c(this.checkRemoteFiles([a.replace("_normal.jpg",".jpg")],a));break;case"tumblr":c(this.checkRemoteFiles([a.replace("_250.jpg","_1280.jpg").replace("_500.jpg","_1280.jpg"),a.replace("_250.jpg","_500.jpg")],a));break;default:c(a)}},checkRemoteFiles:function(a,b){for(var c=0;c<a.length;c++)if(this.filePing(a[c]))return a[c];return b},filePing:function(a){var b=new XMLHttpRequest;b.open("HEAD",a,!1);try{return b.send(),b.readyState==b.DONE&&200==b.status?!0:!1}catch(c){return console.log("ERRR",c),!1}}},DRAGDIS.getMessage=function(a,b,c){switch(a=window.chrome?a:a.message,a.Type){case"GetValue":DRAGDIS.storage.get(a.Key,function(a){window.chrome&&c(a)});break;case"SetValue":this.storage.set(a.Key,a.Value);break;case"ScreenSnapshot":var d=window.chrome&&this.config.browser.version>20||window.safari&&this.config.browser.version>5?1:0;d&&this.imageProcessor.makeSnapshot(function(a){a&&(DRAGDIS.screenSnapshotValue=a)});break;case"RECONNECT":startHubConnection();break;case"REFRESH_CONNECTION":refreshHubConnection();break;case"INJECTION":DRAGDIS.injection.add(b.tab.id,b.tab.url);break;case"GET_BOOKMARKS":DRAGDIS.bookmarks.get(function(a){DRAGDIS.sendMessage({Type:"SET_BOOKMARKS",Value:a})});break;case"CLIPBOARD_COPY":var e=$("<textarea/>").attr("id","copyFrom");e.text(a.Value),$("body").append(e),e.select(),document.execCommand("copy",!0),e.remove(),c&&c({status:"OK"});break;case"Tracker":DRAGDIS.tracker.add(a.Value,b.tab.id);break;case"SendTrackData":DRAGDIS.tracker.send(b.tab.id);break;default:var f=String(b.tab.windowId)+String(b.tab.id);a.Type&&DRAGDIS.api[a.Type](a,f).then(function(){c("response")})}},window.chrome.runtime.onInstalled.addListener(function(a){"install"==a.reason&&DRAGDIS.injection.reInject()}),DRAGDIS.urlParam=function(a,b){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c="[\\?&]"+a+"=([^&#]*)",d=new RegExp(c),e=d.exec(b);return null==e?"":e[1]},DRAGDIS.sendMessage=function(a){window.chrome.tabs.query({active:!0,lastFocusedWindow:!0,highlighted:!0},function(b){$.each(b,function(b,c){window.chrome.tabs.sendMessage(c.id,a)})})},DRAGDIS.loadUserSettings=function(){DRAGDIS.api.getUserSettings({}).then(function(a){DRAGDIS.storage.set("userSettings",a.data)},function(a){new TrackException("Failed to fetch user settings").send(),console.error(a)})};var multiFirePrevent=[];window.chrome.runtime.onMessage.addListener(function(a,b,c){return"undefined"==typeof a.ExtensionIsInjected||a.ExtensionIsInjected?(DRAGDIS.getMessage(a,b,c),void 0):(chrome.tabs.executeScript(b.tab.id,{code:"window.ExtensionIsInjected = true;"}),multiFirePrevent[b.tab.id]&&clearTimeout(multiFirePrevent[b.tab.id]),multiFirePrevent[b.tab.id]=setTimeout(function(a,b){DRAGDIS.injection.add(a,b)},500,b.tab.id,b.tab.url),void 0)});