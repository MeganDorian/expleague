angular.module("fileBlobsFactory",[]).factory("fileBlob",["$http","$q",function(a,b){var c=KNUGGET.config.domain+"api",d="block-",e=["image/jpg","image/jpeg","image/gif","image/png","image/bmp","image/x-windows-bmp","image/tiff","image/x-tiff","jpeg","jpg","gif","png","bmp","tiff","webp"],f={Blob:function(a,b,c){this.submitUri=null,this.azureStorageUrl="",this.uploadType=a,this.done=c,this.MAX_BLOCK_SIZE=262144,this.blockIds=new Array,this.currentFilePointer=0,this.selectedFile=b,this.totalBytesRemaining=b.size;var d=this;this.getWriteToken().success(function(a,b){if("200"==b&&a){d.filename=d.guid();var c=a.replace(/"/g,""),e=c.indexOf("?");d.azureStorageUrl=c.substring(0,e),d.submitUri=d.azureStorageUrl+"/"+d.filename+c.substring(e),d.uploadFileInBlocks()}}).error(function(){d.done({error:!0})})},fileProcessing:function(a){var c,d,g=b.defer();if(a.Base64Image||a.MakeSnapshot){var h=a.Base64Image?JSON.parse(JSON.stringify(a.Base64Image)):JSON.parse(JSON.stringify(KNUGGET.screenSnapshotValue));if(h.length){var i=h.replace("data:image/jpeg;base64,","").replace("data:image/gif;base64,","").replace("data:image/png;base64,","");if(c=KNUGGET.imageProcessor.convertBase64toAb(i),a.MakeSnapshot)c.type="image/jpeg";else{var j=h.split(";base64")[0];j=j.replace("data:",""),-1==$.inArray(j,e)&&g.resolve({status:400,data:{error:"fileTypeIsWrong: "+j}}),c.type=j}d=new f.Blob("Base64String",c,function(b){delete a.Files,delete a.Base64Image,KNUGGET.screenSnapshotValue="",b&&b.filename?(a.Image=b.filename,f.fileUpload(a,g)):g.resolve({status:400,data:{error:"azureFail"}})})}else g.resolve({status:400,data:{error:"snapshotFail"}})}else if(a.Files&&a.Files[0]||("picture"==a.Type||"apicture"==a.Type)&&a.Image){if(a.Files&&a.Files[0]){if(a.Referer="From desktop",-1==$.inArray(a.Files[0].type,e))return!1;a.Files[0].binary=a.Files[0].binary.split(";base64,")[1],c=KNUGGET.imageProcessor.convertBase64toAb(a.Files[0].binary),a.Files[0].size=c.size,a.Files[0].binary=c.binary,a.Files[0].size?d=new f.Blob("File",a.Files[0],function(b){delete a.Files,b&&b.filename&&(a.Image=b.filename,f.fileUpload(a,g))}):g.resolve({status:400,data:{error:"fileIsEmpty"}})}else"picture"!=a.Type&&"apicture"!=a.Type||!a.Image||KNUGGET.imageProcessor.getBiggerImage(a.Image,a.Sitepage,function(b){KNUGGET.imageProcessor.getRemoteImageStream(b,function(b){b&&-1==$.inArray(b.type.toLowerCase(),e)?(console.log("fileTypeIsWrong"),g.resolve({status:400,data:{error:"fileTypeIsWrong"}})):b&&b.size?d=new f.Blob("RemoteImage",b,function(b){delete a.Files,b&&b.filename&&(a.Image=b.filename,f.fileUpload(a,g))}):g.resolve({status:400,data:{error:"fileIsEmpty"}})})});d=null}return g.promise},fileUpload:function(b,d){a.post(c+"/item/add",b).then(function(a){d.resolve(a)})}};return f.Blob.prototype={uploadFileInBlocks:function(){if(this.totalBytesRemaining>0){var a="RemoteImage"==this.uploadType?this.selectedFile:this.selectedFile.binary,b=a.slice(this.currentFilePointer,this.currentFilePointer+this.MAX_BLOCK_SIZE),c=d+this.pad(this.blockIds.length,6);this.blockIds.push(btoa(c)),this.uploadBlock(b),this.currentFilePointer+=this.MAX_BLOCK_SIZE,this.totalBytesRemaining-=this.MAX_BLOCK_SIZE,this.totalBytesRemaining<this.MAX_BLOCK_SIZE&&(this.MAX_BLOCK_SIZE=this.totalBytesRemaining)}else this.combineBlocksList()},uploadBlock:function(a){var b=this,c=this.submitUri+"&comp=block&blockid="+this.blockIds[this.blockIds.length-1],d=a;$.ajax({url:c,type:"PUT",data:d,processData:!1,beforeSend:function(a){a.setRequestHeader("x-ms-blob-type","BlockBlob")},success:function(){b.uploadFileInBlocks()},error:function(){}})},combineBlocksList:function(){for(var a=this,b=this.submitUri+"&comp=blocklist",c='<?xml version="1.0" encoding="utf-8"?><BlockList>',d=0;d<this.blockIds.length;d++)c+="<Latest>"+this.blockIds[d]+"</Latest>";c+="</BlockList>",$.ajax({url:b,type:"PUT",data:c,beforeSend:function(b){b.setRequestHeader("x-ms-blob-content-type",a.selectedFile.type),b.setRequestHeader("x-ms-blob-cache-control","public, max-age=1209600")},success:function(b,c){"success"==c&&a.done({filename:a.azureStorageUrl+"/"+a.filename})},error:function(){}})},getWriteToken:function(){return a.post(c+"/main/getWriteToken")},guid:function(){var h,i,j,a=new Date,b=a.getFullYear(),c=a.getMonth()+1,d=10>c?"0"+c:c,e=a.getDate(),f=10>e?"0"+e:e,g=b+"/"+d+"/"+f+"/";for(h="",j=0;32>j;j++)i=Math.floor(16*Math.random()).toString(16).toUpperCase(),h+=i;var k=this.selectedFile.type.split(";charset");return k="."+k[0].replace("image/","").replace("jpeg","jpg"),"."==k&&(k=""),-1===$.inArray(k,[".jpg",".gif",".png"])&&(k=""),g+h+k},pad:function(a,b){for(var c=""+a;c.length<b;)c="0"+c;return c}},f}]);